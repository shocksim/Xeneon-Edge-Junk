<!DOCTYPE html><html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <title>Radar Widget v4.2 (30s Update)</title>
    
    <style>
        :root {
            --glass-bg: rgba(10, 15, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-radar: #00ff9d;
            --accent-warn: #ffcc00;
            --accent-error: #ff4444;
            --font-ui: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0; background-color: #000; font-family: var(--font-ui);
            overflow: auto; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2672&auto=format&fit=crop');
            background-size: cover;
        }

        .radar-widget {
            position: relative; 
            width: min(900px, 95vw); 
            height: min(650px, 90vh);
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .radar-header {
            min-height: 70px; padding: 0 25px; 
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.2);
        }

        .title {
            font-size: 0.9rem; font-weight: 700; color: var(--accent-radar);
            letter-spacing: 2px; text-transform: uppercase; display: flex; align-items: center; gap: 10px;
        }

        .status-dot { width: 8px; height: 8px; background: var(--accent-radar); border-radius: 50%; box-shadow: 0 0 8px var(--accent-radar); animation: blink 2s infinite; }
        .status-dot.error { background: var(--accent-error); box-shadow: 0 0 8px var(--accent-error); animation: none; }
        
        .location-input {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 15px; border-radius: 20px; color: #ccc;
            font-family: inherit; font-size: 0.85rem; outline: none; width: 180px; transition: all 0.3s;
        }
        .location-input:focus { background: rgba(255,255,255,0.1); border-color: var(--accent-radar); width: 220px; color: white;}

        #map { flex-grow: 1; width: 100%; background: #111; z-index: 1; }

        .flight-stats {
            position: absolute; bottom: 25px; left: 25px; width: 280px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 3px solid var(--accent-radar);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border-radius: 12px; padding: 20px; color: white; z-index: 1000;
        }
        
        .tracking-label { font-size: 0.65rem; color: var(--accent-radar); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; font-weight: 700; opacity: 0.9;}
        .callsign-large { font-size: 2.2rem; font-weight: 800; line-height: 1; color: white; letter-spacing: -1px; }
        .airline-name { font-size: 1rem; color: #bbb; margin-bottom: 15px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-box { background: rgba(255,255,255,0.06); padding: 8px 10px; border-radius: 6px; }
        .stat-label { color: #666; text-transform: uppercase; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.5px; }
        
        .stat-val { font-weight: 600; font-family: 'Consolas', monospace; font-size: 1rem; color: #fff; margin-top: 2px; }
        .unit-suffix { font-size: 0.7rem; color: #888; margin-left: 3px; font-weight: 400; }

        .route-info { 
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .route-point { display: flex; flex-direction: column; }
        .route-code { font-size: 1.4rem; font-weight: 700; color: white; line-height: 1.1;}
        .route-arrow { color: var(--accent-radar); font-size: 1.2rem; opacity: 0.6; }

        .api-warning { font-size: 0.6rem; color: #555; text-align: center; margin-top: 10px; font-style: italic;}

        /* CSS Transitions for smooth movement */
        /* Note: With 30s updates, the plane will move for 2s then stop until next update */
        .leaflet-marker-icon, .plane-icon { transition: transform 2s linear, top 2s linear, left 2s linear; }
        .plane-icon.closest-target path { fill: var(--accent-radar) !important; filter: drop-shadow(0 0 10px var(--accent-radar)); }
        
        .radar-pulse { border: 1px solid var(--accent-radar); border-radius: 50%; animation: expand 4s infinite; box-sizing: border-box; }
        @keyframes expand { 0% { transform: scale(0.1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div class="radar-widget">
        <div class="radar-header">
            <div class="title" id="statusTitle">
                <div class="status-dot" id="dot"></div>
                <span id="statusText">LIVE DATA</span>
            </div>
            <input type="text" class="location-input" id="searchBox" placeholder="Search City..." onkeydown="handleSearch(event)">
        </div>
        
        <div id="map"></div>

        <div class="flight-stats" id="flightPanel">
            <div class="tracking-label">Tracking Nearest Flight</div>
            <div class="callsign-large" id="f-callsign">SCANNING</div>
            <div class="airline-name" id="f-airline">---</div>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-label">Altitude</div>
                    <div class="stat-val" id="f-alt">---</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Speed</div>
                    <div class="stat-val" id="f-speed">---</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Distance</div>
                    <div class="stat-val" id="f-dist">---</div>
                </div>
                 <div class="stat-box">
                    <div class="stat-label">Reg / Tail</div>
                    <div class="stat-val" id="f-reg">---</div>
                </div>
            </div>

            <div class="route-info">
                <div class="route-point">
                    <div class="stat-label">ORIGIN</div>
                    <div class="route-code" id="route-origin">---</div>
                </div>
                <div class="route-arrow">âœˆ</div>
                <div class="route-point" style="text-align: right;">
                    <div class="stat-label">DESTINATION</div>
                    <div class="route-code" id="route-dest">---</div>
                </div>
            </div>
            <div class="api-warning" id="api-status">Route data requires API Key</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURATION ---
        const FLIGHTAWARE_API_KEY = ""; 
        // ---------------------

        // USING AIRPLANES.LIVE
        const ADSB_API_BASE = "https://api.airplanes.live/v2/point";
        
        const AIRLINE_MAP = {
            "AAL": "American Airlines", "UAL": "United Airlines", "DAL": "Delta", "SWA": "Southwest",
            "BAW": "British Airways", "DLH": "Lufthansa", "AFR": "Air France", "KLM": "KLM",
            "UAE": "Emirates", "QTR": "Qatar Airways", "JBU": "JetBlue", "NKS": "Spirit",
            "UPS": "UPS", "FDX": "FedEx", "GTI": "Atlas Air", "ASQ": "ExpressJet", "SKW": "SkyWest"
        };

        let map, planesLayer, radarCircle;
        let currentLat = 37.7749, currentLng = -122.4194; // Default: SF
        let currentlyLockedCallsign = null; 
        let planeRegistry = {}; 

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([currentLat, currentLng], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                maxZoom: 19, subdomains: 'abcd', opacity: 0.9 
            }).addTo(map);
            
            planesLayer = L.layerGroup().addTo(map);
            updateHomeMarker();
            fetchPlanes(); 
            
            // UPDATED: 30 Seconds Interval
            setInterval(fetchPlanes, 30000); 
        }

        function updateHomeMarker() {
            if (radarCircle) map.removeLayer(radarCircle);
            radarCircle = L.marker([currentLat, currentLng], { 
                icon: L.divIcon({ className: 'radar-pulse', iconSize: [100, 100], iconAnchor: [50, 50] }) 
            }).addTo(map);
        }

        // Helper to show errors on the UI instead of console
        function reportError(msg) {
            document.getElementById('f-callsign').innerText = "ERROR";
            document.getElementById('f-callsign').style.color = "#ff4444";
            document.getElementById('f-airline').innerText = msg;
            document.getElementById('dot').classList.add('error');
        }
        function clearError() {
            document.getElementById('f-callsign').style.color = "#ffffff";
            document.getElementById('dot').classList.remove('error');
        }

        async function fetchPlanes() {
            // Radius in Nautical Miles
            const radius = 25; 
            
            try {
                // api.airplanes.live/v2/point/LAT/LON/RADIUS
                const response = await fetch(`${ADSB_API_BASE}/${currentLat}/${currentLng}/${radius}`);
                
                if (!response.ok) throw new Error("Connection Refused");
                const data = await response.json();

                clearError();
                const activeIcaos = new Set();
                let closest = null, minDst = Infinity;

                // Airplanes.live returns object with 'ac' array
                if (data && data.ac) {
                    data.ac.forEach(p => {
                        // Normalize Data 
                        const icao = p.hex;
                        const callsign = (p.flight || "").trim();
                        const lat = p.lat;
                        const lon = p.lon;
                        // alt_baro (barometric) or alt_geom (geometric)
                        const alt = p.alt_baro || p.alt_geom || 0; 
                        const vel = p.gs || 0; // Ground speed in knots
                        const head = p.track || 0;
                        const reg = p.r || "---"; // Tail Number

                        if (lat && lon) {
                            const pLoc = L.latLng(lat, lon);
                            const dst = map.distance(L.latLng(currentLat, currentLng), pLoc);
                            
                            const planeData = { icao, callsign, alt, vel, head, lat, lon, dst, reg };
                            
                            if (dst < minDst) { minDst = dst; closest = planeData; }
                            
                            updateOrAddPlane(planeData);
                            activeIcaos.add(icao);
                        }
                    });
                } 

                if (activeIcaos.size === 0) {
                     document.getElementById('f-callsign').innerText = "NO SIGNAL";
                     document.getElementById('f-airline').innerText = "No aircraft in range";
                }

                // Clean up old planes
                Object.keys(planeRegistry).forEach(icao => {
                    if (!activeIcaos.has(icao)) {
                        planesLayer.removeLayer(planeRegistry[icao]);
                        delete planeRegistry[icao];
                    }
                });

                if (closest) {
                    updateStatsPanel(closest);
                    highlightClosest(closest.icao);
                }

            } catch (e) { 
                reportError("API Limit or Blocked");
            }
        }

        function updateOrAddPlane(p) {
            const html = `
                <svg class="plane-svg" viewBox="0 0 24 24" fill="#fff" style="transform: rotate(${p.head-45}deg); width: 100%; height: 100%;">
                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>`;

            if (planeRegistry[p.icao]) {
                const marker = planeRegistry[p.icao];
                marker.setLatLng([p.lat, p.lon]);
                const iconEl = marker.getElement();
                if(iconEl) {
                    const svg = iconEl.querySelector('svg');
                    if(svg) svg.style.transform = `rotate(${p.head-45}deg)`;
                }
            } else {
                const icon = L.divIcon({ className: 'plane-icon', html: html, iconSize: [30,30], iconAnchor: [15,15] });
                const marker = L.marker([p.lat, p.lon], { icon: icon }).addTo(planesLayer);
                planeRegistry[p.icao] = marker;
            }
        }

        function highlightClosest(targetIcao) {
            Object.keys(planeRegistry).forEach(icao => {
                const marker = planeRegistry[icao];
                const iconEl = marker.getElement();
                if (!iconEl) return;

                if (icao === targetIcao) {
                    marker.setZIndexOffset(1000);
                    iconEl.classList.add('closest-target');
                    iconEl.querySelector('path').style.fill = '#00ff9d';
                } else {
                    marker.setZIndexOffset(0);
                    iconEl.classList.remove('closest-target');
                    iconEl.querySelector('path').style.fill = '#ffffff';
                }
            });
        }

        function updateStatsPanel(data) {
            // METRIC CONVERSIONS (Note: ADSB provides knots/feet natively)
            
            // Feet -> Meters
            const altM = Math.round((data.alt || 0) * 0.3048).toLocaleString();
            
            // Knots -> km/h
            const spdKm = Math.round((data.vel || 0) * 1.852);
            
            // Meters -> km
            const dstKm = (data.dst / 1000).toFixed(1);

            document.getElementById('f-callsign').innerText = data.callsign || "N/A";
            
            document.getElementById('f-alt').innerHTML = `${altM}<span class="unit-suffix">m</span>`;
            document.getElementById('f-speed').innerHTML = `${spdKm}<span class="unit-suffix">km/h</span>`;
            document.getElementById('f-dist').innerHTML = `${dstKm}<span class="unit-suffix">km</span>`;
            
            document.getElementById('f-reg').innerText = data.reg;

            // Airline Logic
            let airlineName = "---";
            if(data.callsign) {
                const prefix = data.callsign.substring(0, 3).toUpperCase();
                airlineName = AIRLINE_MAP[prefix];
                if (!airlineName) {
                    if (/\d/.test(prefix)) airlineName = "Private / GA";
                    else airlineName = `${prefix} / Unknown`;
                }
            }
            document.getElementById('f-airline').innerText = airlineName;

            if (data.callsign !== currentlyLockedCallsign && data.callsign.length > 3) {
                currentlyLockedCallsign = data.callsign;
                fetchRouteData(data.callsign);
            }
        }

        async function fetchRouteData(callsign) {
            const originEl = document.getElementById('route-origin');
            const destEl = document.getElementById('route-dest');
            const statusEl = document.getElementById('api-status');

            originEl.innerText = "---"; destEl.innerText = "---";

            if (!FLIGHTAWARE_API_KEY) {
                statusEl.innerText = "Add FlightAware Key to see Route";
                statusEl.style.color = "#888";
                return;
            }

            statusEl.innerText = "Fetching Route...";
            
            try {
                // FlightAware lookup
                const res = await fetch(`https://aeroapi.flightaware.com/aeroapi/flights/${callsign}?max_pages=1`, {
                    headers: { "x-apikey": FLIGHTAWARE_API_KEY }
                });
                
                if (!res.ok) throw new Error("API Auth Failed");
                
                const json = await res.json();
                if (json.flights && json.flights.length > 0) {
                    const f = json.flights[0];
                    originEl.innerText = f.origin ? f.origin.code_icao : "N/A";
                    destEl.innerText = f.destination ? f.destination.code_icao : "N/A";
                    statusEl.innerText = "Route Data Active";
                    statusEl.style.color = "#00ff9d";
                }
            } catch (e) {
                statusEl.innerText = "Route Not Found";
                statusEl.style.color = "#ff5555";
            }
        }

        async function handleSearch(e) {
            if (e.key === 'Enter') {
                const val = document.getElementById('searchBox').value;
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}`);
                const d = await res.json();
                if (d[0]) {
                    currentLat = parseFloat(d[0].lat);
                    currentLng = parseFloat(d[0].lon);
                    map.setView([currentLat, currentLng], 10);
                    updateHomeMarker();
                    fetchPlanes();
                }
            }
        }

        initMap();
    </script>
</body>
</html>
